#include "regex.h"

int regex_init = 0;
pcre *regex_query_full = NULL, *regex_query_structure = NULL,
		*regex_query_array = NULL;
pcre_extra *regex_study_query_full = NULL, *regex_study_query_structure = NULL,
		*regex_study_query_array = NULL;

volatile static int internal__lock = 0;	// init and end

static const uint8_t internal__regex_query_full[] = {
	0x5e, 0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d,
	0x28, 0x5c, 0x77, 0x7c, 0x5c, 0x2d, 0x29, 0x7b, 0x32, 0x2c, 0x32, 0x35,
	0x33, 0x7d, 0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39,
	0x5d, 0x28, 0x5c, 0x2e, 0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30,
	0x2d, 0x39, 0x5d, 0x28, 0x5c, 0x77, 0x7c, 0x5c, 0x2d, 0x29, 0x7b, 0x32,
	0x2c, 0x32, 0x35, 0x33, 0x7d, 0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a,
	0x30, 0x2d, 0x39, 0x5d, 0x28, 0x5c, 0x3a, 0x5b, 0x61, 0x2d, 0x7a, 0x41,
	0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d, 0x28, 0x5c, 0x77, 0x7c, 0x5c, 0x2d,
	0x29, 0x7b, 0x32, 0x2c, 0x32, 0x35, 0x33, 0x7d, 0x5b, 0x61, 0x2d, 0x7a,
	0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d, 0x29, 0x3f, 0x28, 0x5c, 0x5b,
	0x30, 0x78, 0x28, 0x5c, 0x64, 0x7c, 0x5b, 0x41, 0x2d, 0x46, 0x5d, 0x29,
	0x7b, 0x31, 0x36, 0x7d, 0x5c, 0x5d, 0x29, 0x3f, 0x29, 0x7b, 0x31, 0x2c,
	0x31, 0x35, 0x7d, 0x28, 0x5c, 0x2d, 0x5c, 0x3e, 0x5b, 0x61, 0x2d, 0x7a,
	0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d, 0x28, 0x5c, 0x77, 0x7c, 0x5c,
	0x2d, 0x29, 0x7b, 0x32, 0x2c, 0x32, 0x35, 0x33, 0x7d, 0x5b, 0x61, 0x2d,
	0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d, 0x5c, 0x2e, 0x28, 0x5b,
	0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d, 0x28, 0x5c,
	0x77, 0x7c, 0x5c, 0x2d, 0x29, 0x7b, 0x32, 0x2c, 0x32, 0x35, 0x33, 0x7d,
	0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d, 0x28,
	0x5c, 0x3a, 0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39,
	0x5d, 0x28, 0x5c, 0x77, 0x7c, 0x5c, 0x2d, 0x29, 0x7b, 0x32, 0x2c, 0x32,
	0x35, 0x33, 0x7d, 0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d,
	0x39, 0x5d, 0x29, 0x3f, 0x28, 0x5c, 0x5b, 0x30, 0x78, 0x28, 0x5c, 0x64,
	0x7c, 0x5b, 0x41, 0x2d, 0x46, 0x5d, 0x29, 0x7b, 0x31, 0x36, 0x7d, 0x5c,
	0x5d, 0x29, 0x3f, 0x29, 0x7b, 0x31, 0x2c, 0x31, 0x35, 0x7d, 0x29, 0x7b,
	0x30, 0x2c, 0x31, 0x35, 0x7d, 0x24, 0x00
	};
static const uint8_t internal__regex_query_structure[] = {
	0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d, 0x28,
	0x5c, 0x77, 0x7c, 0x5c, 0x2d, 0x29, 0x7b, 0x32, 0x2c, 0x32, 0x35, 0x33,
	0x7d, 0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d,
	0x5c, 0x2e, 0x28, 0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d,
	0x39, 0x5d, 0x28, 0x5c, 0x77, 0x7c, 0x5c, 0x2d, 0x29, 0x7b, 0x32, 0x2c,
	0x32, 0x35, 0x33, 0x7d, 0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30,
	0x2d, 0x39, 0x5d, 0x28, 0x5c, 0x3a, 0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d,
	0x5a, 0x30, 0x2d, 0x39, 0x5d, 0x28, 0x5c, 0x77, 0x7c, 0x5c, 0x2d, 0x29,
	0x7b, 0x32, 0x2c, 0x32, 0x35, 0x33, 0x7d, 0x5b, 0x61, 0x2d, 0x7a, 0x41,
	0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d, 0x29, 0x3f, 0x28, 0x5c, 0x5b, 0x30,
	0x78, 0x28, 0x5c, 0x64, 0x7c, 0x5b, 0x41, 0x2d, 0x46, 0x5d, 0x29, 0x7b,
	0x31, 0x36, 0x7d, 0x5c, 0x5d, 0x29, 0x3f, 0x29, 0x7b, 0x31, 0x2c, 0x31,
	0x35, 0x7d, 0x00
	};
static const uint8_t internal__regex_query_array[] = {
	0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d, 0x28,
	0x5c, 0x77, 0x7c, 0x5c, 0x2d, 0x29, 0x7b, 0x32, 0x2c, 0x32, 0x35, 0x33,
	0x7d, 0x5b, 0x61, 0x2d, 0x7a, 0x41, 0x2d, 0x5a, 0x30, 0x2d, 0x39, 0x5d,
	0x5c, 0x5b, 0x30, 0x78, 0x28, 0x5c, 0x64, 0x7c, 0x5b, 0x41, 0x2d, 0x46,
	0x5d, 0x29, 0x7b, 0x31, 0x36, 0x7d, 0x5c, 0x5d, 0x00
	};

int RegexInitialize (void) {
	if (__sync_val_compare_and_swap (&internal__lock, 0, 1))
		return 0;	// locked - failure
	else if (regex_init) {	// already initialized
		__sync_synchronize ();
		internal__lock = 0;
		return 0;
	}

	const char *error;
	int erroffset;

	// PCREfy regexes
	regex_query_full = pcre_compile (internal__regex_query_full, 0, &error,
						&erroffset, NULL);
	if (!regex_query_full) {
		__sync_synchronize ();
		internal__lock = 0;
		return 0;
	}
	regex_query_structure = pcre_compile (internal__regex_query_structure, 0,
						&error, &erroffset, NULL);
	if (!regex_query_structure) {
		pcre_free (regex_query_full);
		__sync_synchronize ();
		internal__lock = 0;
		return 0;
	}

	regex_query_array = pcre_compile (internal__regex_query_array, 0, &error,
						&erroffset, NULL);
	if (!regex_query_array) {
		pcre_free (regex_query_full);
		pcre_free (regex_query_structure);
		__sync_synchronize ();
		internal__lock = 0;
		return 0;
	}

	// JIT compile regexes - don't care if error, will just run normally since NULLed
	regex_study_query_full = pcre_study (regex_query_full, PCRE_STUDY_JIT_COMPILE,
						&error);
	regex_study_query_structure = pcre_study (regex_query_structure,
							PCRE_STUDY_JIT_COMPILE, &error);
	regex_study_query_array = pcre_study (regex_query_array, PCRE_STUDY_JIT_COMPILE,
						&error);

	// clean return
	__sync_synchronize ();
	internal__lock = 0;
	return 0;
}

void RegexCleanup (void) {
	// can't fail - so spin until we can acquire the lock
	while (__sync_val_compare_and_swap (&internal__lock, 0, 1));

	if (!regex_init) {	// nothing has happened yet
		__sync_synchronize ();
		internal__lock = 0;
		return;
	}

	if (regex_study_query_full) {
		pcre_free_study (regex_study_query_full);
		regex_study_query_full = NULL;
	}

	if (regex_study_query_structure) {
		pcre_free_study (regex_study_query_structure);
		regex_study_query_structure = NULL;
	}

	if (regex_study_query_array) {
		pcre_free_study (regex_study_query_array);
		regex_study_query_array = NULL;
	}

	if (regex_query_full) {
		pcre_free (regex_query_full);
		regex_query_full = NULL;
	}

	if (regex_query_structure) {
		pcre_free (regex_query_structure);
		regex_query_structure = NULL;
	}

	if (regex_query_array) {
		pcre_free (regex_query_array);
		regex_query_structure = NULL;
	}

	regex_init = 0;
	__sync_synchronize ();
	internal__lock = 0;
	return;
}
